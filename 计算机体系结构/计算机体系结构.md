# 计算机体系结构

推荐书籍：

计算机体系结构（第二版） 清华大学出版社

John L. Hennessy, David A. Patternson; Computer Architecture: A Quantitative Approach; sixth Edition. 

David A. Patternson, John L. Hennessy ; Computer Organization and Design- The Hardware/Software Interface; RISC-V Edition.



参考书：

CSAPP



## 系统结构

**计算机性能提高的原因：**

- 科技
  - 更多晶体管
- 机器组织和实现
  - 更深的流水线
  - 更多并行执行
- 指令集架构
  - 精简指令集
  - 拓展
  - 显式并行



- IO原理
- 存储层次
- 流水线



机器使用多种不同形式的抽象，利用简单模型来隐藏实现的细节：

1. 指令集体系结构和指令集架构
2. 使用虚拟地址





### 计算机系统结构概念

#### 计算机系统结构

系统效率=min(器件速度)*min(系统结构效率)

![](assets/image-20230912151826216.png)

计算机体系结构是软件设计者与硬件设备设计者（VLSI）之间的中间层，是软件与硬件的接口（Interface）

> **基本定义：程序员所看到的计算机的属性，即概念性结构和功能特性。**



系统结构外特性--计算机系统的外观



#### 计算机分类方式

**并行度与并行体系分类**

1. 数据级并行
2. 任务级并行

计算机通过以下方式开发这两类应用并行：

1. **指令集并行**在编译器帮助下，利用流水线思想适度开发数据级并行
2. **向量体系结构和圄形处理器 (GPU)** 将单条指令并行应用于一个数据集
3. **线程级并行**在一种紧搞合硬件模型中开发数据级并行或任务级并行
4. 请求级并行在程序员或操作系统指定的大量去搞合任务之间开发并行



- 按处理机性能分类

  - 按大小分类：<font color= red>**巨型、大型、中型、小型、微型机**</font>
  - 按用途分：科学计算、事务处理、实时控制、工作站、服务器、家用计算机等。
  - 按数据类型分：定点计算机、浮点计算机、向量计算机、堆栈计算机等
  - 按处理机个数和种类划分：单处理机，并行处理机、多处理机、分布处理机，关联处理机
    超标量处理机, 超流水线处理机, VLIW处理机，SMP(对称多处理机)、MPP(大规模并行处理机)、机群(Cluster)系统等
  - 按所使用的器件划分：

- **基于流（Flynn分类法）**

  1. 模型中的重要概念

        指令流（Instruction Stream）：机器执行的指令序列；

        数据流（Data stream）：由指令处理的数据序列；

        多倍性（Multiplicity）：在系统最窄的部件上，处于同一执行阶段的指令和数据的最大可能个数。

  2. 模型中的基本模块

      MM（Memory Module）：内存模块。

      PU（Process Unit）：处理单元

      CU（Control Unit）：控制单元

  3. 按照指令流和数据流的多寡，Flynn将CA分成4种：

      1. 单指令流、单数据流(SISD)：单处理器
      2. 单指令流、多数据流(MISD)：同一指令由多个使用不同数据流的处理器执行。开发数据级并行
      3. 多指令流、单数据流 (MISD):  目前为止，还没有这种类型的商用多处理器，但包含这种类型之后，这种简单的分类方式变得更完整。
      4. 多指令流、多数据流 (MIMD): 每个处理器都提取自己的指令，对自己的数据进行操作，它针对的是任务级并行。


    缺点：
    
    (1)分类太粗
        在SIMD中包括有多种处理机
        对流水线处理机的划分不明确，
        标量流水线为SISD，向量流水线为SIMD
    
    (2)根本问题是把两个不同等级的功能并列对待
         数据流受指令流控制，造成MISD不存在
    
    (3)非冯计算机的分类？其他新型计算机的分类

- **库克分类法：**按控制流和执行流分类

    (1)单指令流单执行流
     SISE(Single Instruction Single Executionstream)，  典型的单处理机

    (2)单指令流多执行流
     SIME(Single Instruction Multiple Executionstream)
      多功能部件处理机、相联处理机、向量处理机、流水线处理机、超流水线处理机、超标量处理机、SIMD并行处理机

    (3)多指令流单执行流MISE
     (Multiple Instruction Single Execution stream)，  多道程序系统 

    (4)多指令流多执行流MIME
     (Multiple Instruction Multiple Execution stream)， 典型的多处理机

- 冯氏分类法

    以最大并行度作为系统结构分类的标准。

    所谓最大并行度Pm是指一个系统在单位时间内能够处理的最多的二进制位数，显然这是一个完全由计算机硬件结构决定的参数。

    最大并行度的数值越大越好。 







### 系统结构设计

#### 计算机系统设计思路

1. **由上向下方法**

   **适合于专用机的设计，从应用到实现级，周期几年。**

    **缺点：当应用对象或范围变化时，效率急剧下降。**

    **原因：软、硬件脱节，不能利用最新的软件技术。**

2. 由下向上方法

  前提：硬件不能改变。
  缺点：易形成软、硬脱节，软件不能获得最新硬件的支持，结果软件繁杂、效率低。



3. 从中间开始方法





抽象简化设计

善用并行性

可靠性法则：没有单点故障的设计。

数据和指令的重复性使用





## 指令系统 (Instruction Set)

- IS是计算机体系结构的主要组成部分
- IS标识硬件和软件之间的接口
- IS是通信硬件和软件之间的桥梁
- 信息系统和软件之间的语义差异越来越大



### ISA (Instruction Set Architecture) 

指令集架构 (ISA) 是计算机抽象模型的一部分，它定义了软件如何控制 CPU。 

ISA 充当硬件和软件之间的接口，指定处理器能够做什么以及如何完成。

ISA 提供了用户与硬件交互的唯一方式。它是机器中对汇编语言程序员、编译器编写者和应用程序程序员可见的部分。



ISA 应当具备**特性**：

- 成本低
- 简洁性
- 架构和具体实现分离：可持续多代，以保持向后（backward) 兼容
- 易于编程/链接/编译



**优秀的 ISA **所具有的**特征**：

- 可持续用于很多代机器上(portability)
- 可以适用于多个领域 (generality)
- 对上层提供方便的功能（convenient functionality)
- 可以由下层有效地实现（efficient implementation )



IBM 360 是第一个将 ISA 与其实现分离的机器，一个 ISA 可能由不同的实现方式



ISA 需要描述的内容：

- 内存地址
- 取址方式
- 操作数的类型和大小
- 操作符



ISA 定义了支持的数据类型、寄存器、硬件如何管理主内存、关键功能（例如虚拟内存）、微处理器可以执行哪些指令以及多个 ISA 实现的输入/输出模型。可以通过添加指令或其他功能，或者添加对更大地址和数据值的支持来扩展 ISA。



- ISA：用户级ISA+特权级ISA
  - 用户级ISA 适用于操作系统和应用程序
  - 特权级ISA 适用于硬件资源的管理（操作系统）



#### ISA 的实现

![image-20231010142433457](assets/image-20231010142433457.png)





### 数据表示

#### 数据表示与数据类型

定义：具有一组**值的集合**，且定义了作用于该集合的操作集

目的：防止不同类型数据间的误操作

基本数据类型：二进制位、二进制位串、整数、十进制数

结构数据类型：数组、字符串、向量、堆栈、队列、记录等



数据类型的确定原则：

- 减少程序运行实践
- 减少CPU和内存间通信
- 数据类型的普遍和实用效率



数据表示增加的原则：

1. 是否提高了系统的有效性

   是否减少实现时间，是否减少专用空间。例如:向量被操纵A=A+B，当采用向量数据表示时，矢量算法组件管道计算可以节省时间，辅助开销时间减少;

2. 数据表示是否具有通用性和利用率就足够了

   通用性:是否适用于多种数据结构。

例子：树结构数据类型和指针数据类型



#### 自定义数据表示

数据存储单元(寄存器、主内存储器、外存储器等)仅存储纯数据。

- 由指令中的运算符解释的:数据类型(定点，浮点，字符，字符串，逻辑，矢量等)进位系统(2、10、16等)
- 数据字长(字、半字、双字、字节等)
- 寻址方式(直接寻址，间接寻址，相对寻址，寄存器寻址)
- 数据功能(地址，数值，控制字，符号等)
- 相同类型的操作(在加法的情况下)

有很多指令在高级语言和应用软件中，数据的属性是由数据本身定义的，高质量语言和机器语言之间的语义差异由编译器来解决

- 60年开始，Burroughs公司引进了自定义的数据表示方式，数据表示方式包括符号

##### 数据标识符

例子：

![img](assets/20200227230742.png)

> 功能位：操作数、指令、地址、控制字
> 陷井位：由软件定义四种捕捉方式
> 封写位：指定数据是只读的还是可读可写
> 类型位：二进制,十进制,定点数,浮点数,复数,字符串,单精度,双精度；绝对地址、相对地址、变址地址、未连接地址等。

**标志符的处理机所占用的存储空间通常要小**

![img](assets/20200227231722.png)

通过合理的设计可以让橙色框比紫色框小

标识符数据表示方法的[优点]：

- 简化了指令系统。

- 由硬件实现一致性检查和数据类型转换。
- 简化程序设计，缩小了人与计算机之间的语义差距。
- 简化编译器，使高级语言与机器语言之间的语义差距大大缩短。
- 支持数据库系统，一个软件不加修改就可适用于多种数据类型。
- 方便软件调试，在每个数据中都有陷井位。

[缺点]：

- 数据和指令长度可能不一致：可以通过精心设计指令系统来解决
- 指令[执行速度]降低，但是采用标志符设计，程序的设计编译调试实践都会降低
- 硬件复杂度增加



##### 数据描述符

数据描述符与标志符的**区别**：标志符只作用于一个数据，而**数据描述符要作用于一组数据**

![image-20231010151645522](assets/image-20231010151645522.png)

举个栗子：
$$
A=\left[\begin{array}{llll}
a_{11} & a_{12} & a_{13} & a_{14} \\
a_{21} & a_{22} & a_{23} & a_{24} \\
a_{31} & a_{32} & a_{33} & a_{34}
\end{array}\right]
$$
<img src="assets/image-20231010152134805.png" alt="image-20231010152134805" style="zoom:67%;" />

第一行的3表示有三个这样的数据（组）并且存了他们的起始地址（**这一行是用来描述之后数据类型的（比如说三个单行数组）**）；后三个101表示每一组数据有4个数据并且存了他们（数据）的起始地址（**这几行是用来描述具体数据的（描述单行数组中的数据）**）；后面就是顺序存放的数据





### 指令

组成：操作 + 源地址 + 目标地址 + 下一个指令地址

类型：数据的处理、存储、移动、程序的流程控制



#### 操作数

- 操作数类型和操作数表示是软硬件的主要界面之一。
- 操作数类型：是面向应用、面向软件系统所处理的各种数据类型。
  - 整型、浮点型、字符、字符串、向量类型等
  - 类型由操作码确定或数据附加硬件解释的标记，一般采用由操作码确定
  - 数据附加硬件解释的标记，现在已经不采用
- 操作数的表示：操作数在机器中的表示，硬件结构能够识别，指令系统可以直接使用的表示格式
  - 整型：原码、反码、补码
  - 浮点：IEEE 754标准
  - 十进制：BCD码/二进制十进制表示

常用操作数类型：

- ASCII character = 1 byte (64-bit register can store  8 characters
- Unicode character or Short integer = 2 bytes = 16 bits （half word) 
- Integer = 4 bytes = 32 bits (word size on many RISC Processors)
- Single-precision float = 4 bytes = 32 bits (word size)
- Long integer = 8 bytes = 64 bits (double word)
- Double-precision float = 8 bytes = 64 bits (double word)
- Extended-precision float = 10 bytes = 80 bits (Intel architecture)
- Quad-precision float = 16 bytes = 128 bits



#### 寻址方式

- 寻址方式：如何说明要访问的对象地址
- 有效地址：由寻址方式说明的某一存储单元的实际存储器地址。有效地址 vs. 物理地址



重要的寻址方式:

- 偏移寻址方式, 立即数寻址方式, 寄存器间址方式
- SPEC测试表明，使用频度达到 75%--99%

偏移字段的大小应该在 12 - 16 bits

- 可满足75%-99%的需求

立即数字段的大小应该在 8 -16 bits

- 可满足50%-80%的需求



高位交叉 低位交叉
