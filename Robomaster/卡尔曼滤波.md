# 卡尔曼滤波

卡尔曼滤波是一种估计线性动态系统状态的递归方法，尤其适用于含有噪声的系统。卡尔曼滤波可以分为两个阶段：预测(prediction)和更新(update)。

对于Kalman Filter的理解，用过的都知道“**黄金五条**”公式，且通过“**预测**”与“**更新**”两个过程来对系统的状态进行最优估计，但完整的推导过程却不一定能写出来，希望通过此文能对卡尔曼滤波的原理及状态估计算法有更一步的理解。

假设系统的动态可以用以下线性模型描述：
$$
x_k = A*x_{k-1} + B*u_{k} + w_{k-1} \tag 1 \\
$$
观测方程为：
$$
z_k = H_k x_k + v_k \tag 2
$$
其中：

- $x_k$ 是在时间 $k$ 的状态向量
- $A$ 是状态转移矩阵
- $u_{k}$ 是在时间 $k$ 的测量值
- $B$ 是控制输入矩阵
- $w_{k-1}$ 是过程噪声，指的是系统通常不完全是线性时变模型，通常假设它服从均值为0的正态分布 N(0, Q)，其中 $Q$ 是协方差矩阵。

- $z_k$ 是在时间 $k$ 的预测值,
- $H$ 是状态观测矩阵,
- $v_k$ 是测量噪声，是由于状态矩阵本身的误差，或者测量值的误差，假设它服从均值为0的正态分布 N(0, R)，其中 $R$ 是协方差矩阵。

## 卡尔曼滤波公式推导

### 状态估计协方差

对于状态估计算法而言，我们可以获取状态量的三个值：**状态预测值**（ $𝑥_𝑘^−$ ）、**最优估计值**（ $\hat 𝑥_𝑘 $）以及**状态真实值**（ $𝑥_𝑘$ ），卡尔曼滤波的原理就是利用卡尔曼增益来修正状态预测值，使其逼近真实值。

在预测阶段，我们预先估计当前时间步的状态和误差协方差，基于先前的最优估计和控制输入：

- 由公式1**状态预测方程**可得：**黄金1条**

$$
\hat{x}^-_k = A *\hat{x}_{k-1} + B *u_{k-1} \tag{3}
$$

- 状态最优估计值 $\hat 𝑥_𝑘$ 可由**状态更新方程**可得：**黄金2条**

$$
\hat{x}_k = \hat{x}^-_k + K (z_k - H_k \hat{x}^-_k) \tag{4}
$$

这个公式中的 $K_k$ 被称为卡尔曼增益，它的作用是平衡观测数据和模型预测之间的不确定性。

获取误差：
$$
e_{k}^{-}=x_{k}-\tilde{x}_{k}^{-}\\
e_k=x_{k}-\tilde{x}_{k}\\
P_{k}^{-}=E[e_{k}^{-}*e_{k}^{-T}]\\
P_{k}=E[e_{k}*e_{k}^{T}] \tag{5}
$$
将(2)带入(4)：
$$
\tilde{x}_k=\tilde{x}_k^-+KH*x_k-KH*\tilde{x}_k^-+Kv_k	\tag{6}
$$
两侧同时减去$x_k$：
$$
\tilde{x}_k-x_k=\tilde{x}_k^--x_k+KH(x_k-\tilde{x}_k^-)+Kv_k \tag{7}
$$
联立(5.1)和(5.2)：
$$
e_k=(I-KH)*e_k^--K*v_k \tag{8}
$$
由误差矩阵(5.4)可得到：
$$
P_k=E[e_k*e_k^T]=(I-KH)*P_k^-*(I-KH)^T+K*R*K^T \tag{9}
$$

### 状态变量

我们希望最优状态估计的协方差最小，使其逼近于真实值，在卡尔曼中使用迹来作为不确定的度量

迹（Trace）函数的使用通常与评估估计误差的大小和系统的不确定性有关。迹函数作用于协方差矩阵 $P_k$，提供了一个简单的量度来衡量状态估计的总体不确定性。

具体来说，协方差矩阵 $P_k$ 的元素 $P_{ij}$ 表示状态向量中第 $i$ 个和第 $j$ 个元素的协方差。如果你用迹来测量这个矩阵，它实际上相加了协方差矩阵的对角线元素，这些对角元素代表了每个状态变量估计的方差（即每个状态变量的不确定性度量）。

使用迹作为不确定性的度量具有以下优点：

1. **简化计算**：迹是协方差矩阵对角元素的总和，计算上非常直接和高效。
2. **直观理解**：对角元素的总和（迹）直观地提供了状态估计不确定性的量度。较大的迹值表示较高的不确定性，而较小的迹值表示较低的不确定性。

$$
J=\sum_{min}tr(P_k)
$$

对K求偏导：
$$
\frac{\partial tr(P_k)}{\partial K}=-2(P_k^-H^T)+2K(HP_k^-H^T+R)=0
$$
由此可得最优化估计下卡尔曼增益矩阵$K$为：
$$
K_k = P^-_k H^T_k (H_k P^-_k H^T_k + R_k)^{-1}
$$


$$ P_k = (I - K_k H_k) P^-_k $$



$$ P^-_k = A *P_{k-1} *A^T + Q $$

### 2. 更新阶段
在更新阶段，我们使用当前的观测 $z_k$ 来纠正之前的预测，得到更精确的估计：





然后，更新估计的状态和协方差：




这就完成了卡尔曼滤波公式的推导。在每个时间步进行迭代，不断更新状态估计，从而适应动态变化和观测噪声。



# 拓展卡尔曼滤波



