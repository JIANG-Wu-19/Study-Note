# 数据库系统原理

## 引言

#### 数据管理的阶段

- 人工管理
  - 纸质或者说物理方式
  - 容易丢数据
  - 数据重复
- 计算机出现以后，通过文件系统方式存储数据
  - 如今仍然使用文件方式保存
  - 不能实现记录和数据项的访问和共享，数据冗余大，利用率低
  - 逻辑文件和物理文件间的独立性差，物理文件结构的改变影响程序的运行。
  - 应用程序设计困难，程序员要进行程序设计实现对数据的操作，（查找、插入、删除、修改）对程序员的算法和程序设计的能力要求高。
  - 易造成数据的不一致性。 



#### 数据库系统的组成

- 数据库
  - 逻辑上来看，它是数据的集合
  - 它把我们关心的数据的集合按一定结构组织在一起
  - 在计算机的物理上看来它就是一些数据集的文件
- 数据库管理系统（核心）
  - 专门描述、管理和维护数据库的系统
  - 建立在操作系统之上，对数据库统一管理
- 数据库应用程序
  - 允许用户开发数据库的工具
  - 能让用户方便的获取、更新和利用数据库管理系统中管理和维护的数据库中的数据。
  - 是数据库系统的核心组成部分,它连接着数据库应用程序和数据库



<img src="pics/image-20230628123114053.png" alt="image-20230628123114053" style="zoom:50%;" />




### 体系结构

#### 三级结构两级独立性

三个抽象极：用户级，概念级，物理级

<img src="pics/image-20230530141853200.png" alt="image-20230530141853200" style="zoom:67%;" />

物理级对应**内模式：**描述数据的实际存贮组织，内部记录组成，又称为内部视图，物理级数据库并不是真正的物理存贮，而是是最接近于物理存贮的级

概念极对应**概念模式：**介于用户级和物理级之间，是所有用户视图的最小并集，数据库管理员看到的

用户级对应**外模式：**用户看到和使用的数据库，又称为用户视图，不同用户视图可以互相重叠，用户的所有操作都是针对用户视图进行



用户级和概念级：

- 一个数据库可有多个不同的用户视图，每个用户视图由数据库某一部分的抽象表示所组成。

- 一个数据库应用系统只存在一个DBA视图，它把数据库作为一个整体的抽象表示。概念级模式把用户视图有机地结合成一个整体，综合平衡考虑所有用户要求。

- 实现数据的一致性、最大限度降低数据冗余、准确地反映数据间的联系。



数据库系统两级独立性：逻辑独立性、物理独立性

- 三个抽象级间通过两级映射（根据一定的对应规则）进行相互转换，
- 使得数据库的三级形成一个统一整体。
- 映射隔离了各层之间的相互影响，实现数据独立性。
- 各层间的映射能力决定数据独立性程度。



物理独立性：隔离变化，底层数据的变化对于数据的使用者来说是不透明的

逻辑独立性：模式和外模式之间，是他们的映射转换实现逻辑独立性





#### 数据模型

- 关系模型
- 实体-联系模型
- 基于对象的数据模型



### 数据的存储和查询





## 关系模型与完整性
<img src="pics/image-20230630010249796.png" alt="image-20230630010249796" style="zoom: 67%;" />



### 数据描述

- 现实世界
  - 存在于人们头脑之外的客观世界，称为现实世界
  - 现实世界中的数据是原始数据，是数据库设计者的原材料
- 信息世界
  - 信息世界是现实世界在人们头脑中的反映，并用文字和符号记载下来
- 机器世界（或计算机世界）
  - 信息世界的信息在机器世界中以数据形式存储



#### 信息世界的数据描述术语

实体

- 客观存在东西称为实体。实体可以是具体的对象，也可以是抽象的事件，例如：一名男学生，一辆汽车等；一次足球比赛，一次借书等。

实体集

- 性质相同的同类实体的集合，称为实体集。例如所有的男学生，全足球锦标赛的所有比赛等。

属性

- 实体有很多特性，每一个特性称为属性。每个属性有一个值域，其类型可以是整数型、实数型或字符串型。例如学生有学号、姓名、年龄等属性，相应值域为字符串、字符串、整数。

实体键

- 能唯一标识每个实体的属性或属性集，称为实体的键。例如学生的学号可以作为学生实体的键。

#### 机器世界的数据描述术语

字段

- 标记实体属性的命名单位称为字段或数据项。它是可以命名的最小信息单位，所以又叫数据元素或初等项。字段的命名往往和属性名相同。例如学生有学号、姓名、年龄、性别等字段。

记录

- 字段有序集合称为记录。一般用一个记录描述一个实体，所以记录又可以定义为能完整地描述一个实体的字段集。例如一个学生记录（990001，王军，20，男，计算机）由有序的字段集组成。

文件

- 同一类记录的汇集称为文件。文件是描述实体集的，所以它又有可以定义为描述一个实体集的所有记录集。例如所有的学生记录组成了一个学生文件。

记录键

- 能唯一标识文件中每个记录的字段或字段集，称为文件的键（或记录的键）。这个概念与实体集的键概念相对应。例如学生的学号可以作为学生记录



### 实体－联系模型 ER模型

实体 属性 联系

联系有1-1，1-n，n-n

实体一般是长方形来体现，而属性则是椭圆形，关系则用菱形表示，关系也可能有属性

每个实体有一个键，唯一的确认实体



在建立 E-R图的时候，应根据实际应用首先确定哪些是实体集，有多少个实体集，其次确定实体集的属性，然后再确定这些实体集之间存在什么联系及联系的属性。



属性的更详细的画法

- E-R图中: 带下划线的属性为实体键或实体键的一部分。 组合属性用一个树型表示。多值属性用虚线椭圆表示或标出。
- 关系型数据库系统不能处理组合属性和多值属性的情况，实际操作时要转化成原子属性和单值属性的情况。



DBMS主要有：

1. 层次数据库系统
2. 网状数据库系统
3. 关系数据库系统



### 关系数据库

#### 介绍

IBM提出

理论基础：关系代数

数据结构：二维表

定义：

实体和联系均用二维表来表示的数据模型称为关系数据模型



#### 关系模式

二维表表头哪一行，称为关系模式，关系模式名互不相同



**关系->表**

**元组->行**

**属性->列**

**变域->属性的值域**

**关键字->key**

**候选关键字：**
一个关系中，存在多个属性或属性组合都能唯一表示该元组，则称为候选关键字

**主关键字：**

候选关键字中的一个

**外部关键字：**

> 外键是关系模型中的一种约束，它用于建立和加强两个表数据之间的链接。一个表中的一个字段引用了另一个表中的主键，引用的表叫做从表，被引用的表叫做主表



### 关系数据模型完整性约束规则（必考）

- 完整性约束是关系数据库模型的重要组成部分 
  - 数据库管理系统通过对单个属性的取值范围、主关键字的属性以及属性之间的关系加以制约（约束），以及提供对违反约束的处理过程实现保证数据库的数据与现实世界的一致性。 

- 域完整性 
  - 属性取值必须取自于值域
  - 属性是否能取空值由其语义决定。域完整性是最基本的约束 

- 实体完整性
  - 主关键字值必须是唯一的且任何组成成份都不能是空值。 

- 引用／参考完整性 
  - 一用来保证表之间的关系的完整 

- 用户自定义完整性
  - 创建业务规则来确保值的有效性，从而使之落在需要范围之内



域完整性

- 又叫列完整性，判断某个列的值是不是有效，是否为空
- 相关技术：默认值，空值，CHECK约束，规则

实体完整性
- 又叫行完整性，保证表中的行有唯一标示符
- 相关技术：主键，UNIQUE唯一键

参考完整性
- 用来保证表之间的关系的完整
- 相关技术：外键

用户定义完整性
- 这样可以允许创建业务规则来确保值的有效性，从而使之落在需要范围之内。
- 相关技术：触发器和存储过程

关系数据模型的操作必须满足关系的完整性约束条件。





### 将实体联系模型转化为关系数据模型 

**规则1** 

- **每个实体类型转化为一个关系模式**，实体的属性转化为该为关系模式的属性：实体标识符（实体健）转化为该关系模式的键，每一个实体转化为该关系模式对应关系的一个元组。 

**规则2** 

- 实体类型间的每一个自身有属性的联系转化为一个关系模式，该联系的属性直接转化为该关系模式的属性，与该联系所关联的所有实体类型的实体键都转化为该关系模式的属性，共同组成该关系模式的主关键字。 

**规则3** 

- 若联系自身无属性

- 对1:N型联系，则1侧实体类型的实体健转化为属性加入到N侧实体类型 

- 对M:N型联系，则两侧实体类型的实体键都转化为属性，互相加入到对侧实体类型所转化后的关系模式中，和该关系模式的原主关键字一起，共同构成该关系模式新的主关键字；或者建立一个新关系模式关键字是关系的双方的主键共同组成（推荐后面这种）

- 对1:1型联系，则按1:N或M:N处理。



**简单说：**有属性的实体类型或者联系变成表，没有属性的联系将1的属性放到N中



## 函数依赖与范式

### 规范化

好的关系模式具有四个条件：

- 尽可能少的数据冗余
- 没有插入异常
- 没有删除异常
- 没有更新异常



### 函数依赖：

符号表示：
                    （1）若X→Y，则X称为决定因素。 
                    （2）若X→Y，Y→X，则记作X←→Y。 
                    （3）若Y不函数依赖于X，则记作X\→Y。 



### 分类和键

- 平凡函数依赖

- 非平凡函数依赖

  <img src="pics/image-20230630084220738.png" alt="image-20230630084220738" style="zoom:50%;" />

- 完全函数依赖

  - 子集不能映射

- 部分函数依赖

  - 子集可以映射

- 传递函数依赖

  - 传递性



### 键

候选键

主键

主属性

外键



### 范式

在关系模式的设计中，函数依赖起着重要作用，关系模式设计的好坏依赖于它的函数依赖是否满足特定的要求。满足特定要求的模式称为范式（Normal Form）。满足不同程度要求的模式为不同范式

#### 第一范式

属性不可分解



#### 第二范式

每一个非主属性完全函数依赖于主键



#### 第三范式

每一个非主属性不传递函数依赖于主键



#### BCNF范式

**在野者不能干政**：**老板不能受到候选人的制约**

主属性不能由另一个主属性决定！！！



### 判断候选码

1. 没在函数依赖集中，一定在候选中
2. 只在右边，一定不是候选
3. 只在左边，一定是候选
4. 能唯一的标识元组



### 最小依赖集

1. 先将右边分成独立的
2. 一个个去除X->a，然后求X的闭包，看是否包含a，如果包含就可以去除
3. 对多个的属性决定的关系，依次去除其中一个属性，看剩下的属性在前后两个闭包的内容是否相等，相等可以去除

## 关系代数

### 选择

<img src="pics/image-20230630104457674.png" alt="image-20230630104457674" style="zoom:50%;" />



### 投影

选择列组成新的关系，可能需要删除某些重复行

<img src="pics/image-20230630104830417.png" alt="image-20230630104830417" style="zoom:67%;" />



### 连接

自然连接时等值连接中删除等值的部分

<img src="pics/image-20230630105405483.png" alt="image-20230630105405483" style="zoom:67%;" />



### 除

象集包含对面的域

<img src="pics/image-20230630110123698.png" alt="image-20230630110123698" style="zoom: 50%;" />



## 视图

视图是一个不存在的表，其内容是由查询定义的

1. 集中用户的数据
2. 简化用户管理安全性
3. 隔离变化





## 可靠性

### 备份与恢复

> 备份和还原组件为存储在数据库中的数据提供重要的保护手段。

以SQL Server例子 提供以下完善的备份功能：

- 完整数据库备份
  - 备份数据库的完整复本。
- 差异备份
  - 备份自上一次完整数据库备份后修改过的数据库页。
- 事务日志备份
  - 仅备份事务日志。
- 文件或文件组备份
  - 仅备份数据库中某个文件或文件组，用于恢复位于故障磁盘上的那部分。



### 并发控制

数据库是一个共享资源，允许多个用户同时访问。多用户数据库系统中多事务的执行方式有：

（1）串行执行：每个时刻只有一个事务运行，其他事务必须等到该事务结束后才能运行，它不能发挥数据库共享资源的特点。

（2）交叉并发方式：事务并行操作，轮流交叉运行，这是单处理机系统的并发方式，能够减少CPU空闲时间，提高系统的效率。

（3）同时并发方式：多处理机系统中，每个处理机可以运行一个事务，多个处理机可以同时运行多个事务，实现多个事务真正的并行运行。这是最理想的并发方式，但受制于硬件环境。

### 事务

> 是用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位

事务是事务的ACID特性：

- 原子性（Atomicity）：恢复和并发控制的基本单位，要不全执行，要不全不执行
- 一致性（Consistency）：事务前和后数据库完整性保持住，但事务中可以变化 
- 隔离性（Isolation）：一个事务执行时不被其他事务干扰
- 持续性（Durability ）：事务执行后，数据的改变将是永久性的

## 安全性

![image-20230630094536807](pics/image-20230630094536807.png)

## 考试

十个选择

四个简答

规范化题  主键 函数依赖关系 关键字

设计题  ER图

编程 SQL编程





判断范式

ER图

选择候选码

分解关系模式
